#!/bin/bash

NOW=$(date +"%Y%m%d %H:%M")

usage () 
{ 
  echo "Usage: $0 [-c <critical threshold (percentage)>] [-w <warning threshold (percentage)>] [-e <email address to send the report>]" ;
  exit;
}
mem_check()
{
  USED_MEM_PERCNT=$( free | grep Mem: | awk '{print $3/2 *100.0}');
  USED_MEMORY=${USED_MEM_PERCNT%.*}                                   #convert float to decimal
  if [ $USED_MEMORY -ge $crTh -a $USED_MEMORY -lt 100 ]; then
    echo "2";
    echo "Subject: " $NOW " memory check -critical" > topten.txt;
    ps axo ruser,%mem,comm,pid | sort -nr | head -n 11 >> topten.txt;
  else
  if [ $USED_MEMORY -ge $waTh -a $USED_MEMORY -lt $crTh ]; then
    echo "1";
    
  else
  if [ $USED_MEMORY -lt $waTh -a $USED_MEMORY -ge 0 ]; then
    echo "0";
  fi
  fi
  fi
  exit;
}
validation()
{
  echo "Percentage of critical threshold must be greater than warning threshold";
}

while getopts ":c:w:e:" opt; do
  case $opt in
    c)
      crTh="$OPTARG"
      ;;
    w)
      waTh="$OPTARG"
      ;;
    e)
      emAd="$OPTARG"
      ;;
    *)
      echo "Requires a parameter" 
      usage
      ;;
  esac
done
shift $((OPTIND-1))

if [[ ! -z $crTh && ! -z $waTh && ! -z $emAd ]]; then
  if [ $crTh -ge $waTh ]; then
    mem_check
  else
    validation
    usage
  fi
fi

if [[ -z $crTh || -z $wrTh || -z $emAd ]]; then
  usage
fi
